FROM python:3.13-slim

# Install Node.js 20 and uv
RUN apt-get update && \
    apt-get install -y curl && \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    curl -LsSf https://astral.sh/uv/install.sh | sh && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Add uv to PATH
ENV PATH="/root/.local/bin:${PATH}"

WORKDIR /app

# Copy MCP server files
COPY . .

# Install Python dependencies using uv
RUN uv sync

# Install supergateway globally
RUN npm install -g supergateway

# Make run script executable
RUN chmod +x run_mcp.sh

# Update run_mcp.sh to use uv run
RUN sed -i 's|python main.py|uv run python main.py|g' run_mcp.sh

# Expose MCP server port
EXPOSE 8840

# Environment variables (can be overridden)
ENV API_PROXY_URL=http://user-service:8031
ENV AUTH_API_URL=http://user-service:8030
ENV MAILPIT_SMTP_HOST=mailpit

# Start MCP server with supergateway
CMD ["supergateway", "--port", "8840", "--stdio", "./run_mcp.sh"]

